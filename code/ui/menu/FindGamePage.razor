@using System
@using Sandbox;
@using Sandbox.UI;
@using Sandbox.Menu;
@attribute [StyleSheet]
@inherits Panel
@implements INavigatorPage
@namespace Facepunch.Pool.Menu

<root class="layout">

    <div class="navbar">

        <div class="left">
            <a class="button" href="/"> Home </a>
            <span class="block">&gt;</span>
            <span class="block">Find a Game</span>
        </div>

        <div class="right">
            
        </div>
    </div>

    <div class="body columned">
       <span class="waiting-label">Waiting for Opponent...</span>
    </div>

</root>

@code
{
    private TimeUntil NextFindLobbies { get; set; }
    private bool IsLoadingGame { get; set; }
    private bool IsPageOpen { get; set; }
    private ILobby Lobby { get; set; }

    public void OnNavigationOpen()
    {
        IsPageOpen = true;
        JoinOrCreateLobby();
    }

    public void OnNavigationClose()
    {
        IsLoadingGame = false;
        IsPageOpen = false;
        Lobby?.Leave();
        Lobby = null;
    }

    private async void JoinOrCreateLobby()
    {
        Lobby?.Leave();
        Lobby = null;

        var lobbies = await Game.Menu.QueryLobbiesAsync();

        foreach ( var lobby in lobbies )
        {
            if ( lobby.MemberCount > 0 && lobby.MemberCount < lobby.MaxMembers )
            {
                var success = await lobby.JoinAsync();

                if ( success && IsPageOpen )
                {
                    Lobby = lobby;
                    return;
                }
            }
        }

        if (!IsPageOpen) return;

        Lobby = await Game.Menu.CreateLobbyAsync(2);
        Lobby.Map = "maps/pool_lounge_v2.vpk";

        NextFindLobbies = 1f;
    }

    private async void TryFindAvailableLobbies()
    {
        var lobbies = await Game.Menu.QueryLobbiesAsync();

        foreach ( var lobby in lobbies )
        {
            if ( lobby.MemberCount > 0 && lobby.MemberCount < lobby.MaxMembers )
            {
                var success = await lobby.JoinAsync();

                if ( success && IsPageOpen )
                {
                    Lobby?.Leave();
                    Lobby = lobby;

                    return;
                }
            }
        }
    }

    public override void Tick()
    {
        base.Tick();

        if (IsLoadingGame) return;

        if ( NextFindLobbies )
        {
            TryFindAvailableLobbies();
            NextFindLobbies = 5f;
        }

        if (Lobby == null) return;

        if ( Lobby.Owner.IsMe )
        {
            if ( Lobby.MemberCount == Lobby.MaxMembers )
            {
                Lobby.LaunchGameAsync();
                IsLoadingGame = true;
            }
        }
        else if (Lobby.State == "active")
        {
            Lobby.LaunchGameAsync();
            IsLoadingGame = true;
        }
    }
}
